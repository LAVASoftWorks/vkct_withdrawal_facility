<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Piggy Bank Withdrawal Facility</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">
    <script src="https://unpkg.com/@solana/web3.js@1.98.2/lib/index.iife.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
            integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
          integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script>
        //---------------------//
        // INITIAL DEFINITIONS //
        //---------------------//
        
        ///////////////////////////////
        const script_version = "0.6.0";
        ///////////////////////////////
        
        let API_URL = "https://api.mainnet-beta.solana.com";
        let connection;
        
        let wallet          = null; // Will hold the Phantom wallet public key
        let wallet_provider = null;
        let wallet_address  = null;
        const explorerLink = "https://solscan.io/<endpoint>/<data>";
        
        const PIGGYBANK_PROGRAM_ID = "LvPibsi1V7z71Nmqt3pnafDBgaoeMhiwNVDYMdYc2tG";  // Update from the contract build
        const IDL_DISCRIMINATOR    = [183, 18, 70, 156, 148, 109, 161, 34];          // Update from the IDL
        const TOKEN_REGISTRY_PDA   = "53ZNFh4G6z1H4XF9bKXsXFntBWKArzU4NKFQGRDo9vmr"; // Update from the registry init script
        const COLLECTION_REG_PDA   = "DKhbsibDHiFuuPgFg7WHa5pivAvxjKupJyA4t8uVG1kp"; // Update from the registry init script
        const PIGGYBANK_TRAIT_KEY  = "Piggy bank address"; // This is set by the tokenization backend
        const COLLECTION_TRAIT_KEY = "CMRA";                           
        
        const SUPPORTED_TOKENS = {
            "NPATO": {name: "NegaPato",        address: "3SLKyhCAgvNsNji8Wx9bWvDm1BJuDrQnE2zZP9fJpump", decimals: 6},
            "USDC":  {name: "USDC stablecoin", address: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v", decimals: 6},
            "BONK":  {name: "Bonk",            address: "DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263", decimals: 5},
        };
        
        // v--- Solana predefs ------------
        const TOKEN_PROGRAM_ID            = new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA");
        const ASSOCIATED_TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL");
        const METADATA_PROGRAM_ID         = new solanaWeb3.PublicKey("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s");
        // ^-------------------------------
    </script>
    <style type="text/css">
        * {box-sizing: border-box;}
        body {font-family: arial, helvetica, sans-serif;}
        #piggybank_withdrawal_widget.blocked {cursor: wait;pointer-events: none;filter: grayscale(100%) blur(1px);}
        .fixed_font {font-family: 'lucida console', consolas, 'courier new', courier, monospace;}
        .aligncenter {text-align: center;}
        .alignright {text-align: right;}
        .frame {display: inline-block;background: lightgoldenrodyellow;border: 1px solid silver;color: black;padding: 2px 4px;}
        .ellipsified {display: inline-block;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;}
        .pseudo_link {cursor: pointer;}
        .nowrap {display: inline-block; white-space: nowrap;}
        #step1, #step2 {margin-top: 20px;border-radius: 10px;}
        #nfts_list {display: flex;flex-wrap: wrap;gap: 20px;}
        .nft {position: relative;display: inline-block;width: 180px;vertical-align: top;border: 1px solid transparent;border-radius: 10px;background: whitesmoke;padding: 5px;pointer-events: none;}
        .nft .image {position: relative;display: inline-block;vertical-align: top;width: 100%;aspect-ratio: 1/1;border-radius: 10px;margin-bottom: 5px;}
        .nft .image img {object-fit: contain;object-position: center center;width: 100%;height: 100%;}
        .nft .mint {display: inline-block;width: 100%;border: 1px solid silver;border-radius: 5px;text-align: center;padding: 2px;margin-bottom: 5px;}
        .nft .symbol {display: inline-block;width: 100%;text-align: center;padding: 2px;}
        .nft .name {display: inline-block;width: 100%;white-space: nowrap;overflow: hidden;padding: 2px;text-overflow: ellipsis;}
        .nft.enabled {cursor: pointer;pointer-events: auto;}
        .nft.enabled:hover {border-color: blue;}
        .nft.selected {background-color: azure;border-color: blue;color: blue;pointer-events: none;}
        .nft.disabled {background-color: white;border-color: dimgray;color: dimgray;pointer-events: none;filter: grayscale(100%);opacity: 0.5;}
        .nft.disabled .image img { filter: brightness(1.5) contrast(0.5); }
        #nft_info {display: grid;width: 100%;gap: 10px;grid-template-columns: auto 1fr auto;margin-top: 10px;}
        #tokensList { max-width: calc(100vw - 64px); overflow:auto;) }
        .tokenElement {display: grid;margin: 10px 0;min-width: 600px;grid-template-columns: 24px 80px 1fr 2fr 1fr 0.5fr;justify-items: start;align-items: center;gap: 10px;}
        .tokenElement.heading { font-style: italic; pointer-events: none; }
        #withdrawalResult.done {background-color: greenyellow;border-radius: 10px;color: green;padding: 10px 5px;text-align: center;border: 1px solid green;font-size: large;}
        #progress_overlay {pointer-events: none;position: absolute;top: 0;left: 0;width: 100vw;height: 100vh;display: none;}
        #progress_overlay.visible {display: block;}
        #progress_message {display: inline-block;background: lightgoldenrodyellow;border: 2px solid silver;box-shadow: 5px 5px 10px black;text-align: center;position: absolute;top: 50%;left: 50%;padding: 5px;border-radius: 5px;transform: translate(-50%, -50%);}
        #initial_warning {display: none;position: absolute;top: 0;left: 0;width: 100vw;height: 100vh;background: rgba(0, 0, 0, 0.5);backdrop-filter: blur(5px);}
        #initial_warning .content {position: relative;top: 50%; left: 50%; transform: translate(-50%, -50%);max-width: 80vw; max-height: 80vh;display: grid;grid-template-rows: auto 1fr;gap: 10px;background: #fffc9e;border: 1px solid pink;border-radius: 20px;padding: 10px;margin: 1em 0;box-shadow: 5px 5px 20px black;}
        #initial_warning .inner_content {overflow: auto;}
        #initial_warning .inner_content *:first-child {margin-top: 0;}
        #initial_warning .inner_content *:last-child {margin-bottom: 0;}
        #credits { margin-top: 20px; padding-top: 20px; border-top: 2px solid silver; font-size: small; line-height: 1.5em; }
        a { display: inline-block; white-space: nowrap; }
    </style>
</head>
<body>

<!-- ============= -->
<!-- Widget itself -->
<!-- ============= -->

<div id="piggybank_withdrawal_widget">
    <h1 style="margin-bottom: 10px">
        <i class="fa fa-wallet"></i>
        Piggy Bank Withdrawal Facility
    </h1>
    <h2 style="margin-top: 0; font-style: italic;">
        Version <span class="script_version">N/A</span>
    </h2>
    
    <p>
        Solana API:
        <input type="url" id="API_URL" value="" style="width: 360px">
        <select onclick="let val = $(this).find('option:selected').val(); $('#API_URL').val(val);" style="width: 70px">
            <option disabled selected>Options:</option>
            <option value="https://api.mainnet-beta.solana.com">Solana (default)</option>
            <option value="https://solana-mainnet.gateway.tatum.io">Tatum</option>
        </select>
        <button onclick="setApiUrl()"><i class="fa fa-check"></i> Set &amp; reload</button>
        <button onclick="$('#API_URL').val(''); setApiUrl();"><i class="fa fa-refresh"></i> Reset</button>
    </p>
    
    <p>
        Your wallet:
        <input type="text" id="dest" disabled value="" style="width: 360px">
        <button id="connectWallet"    onclick="connectWallet()"><i class="fa fa-sign-in"></i> Connect wallet</button>
        <button id="disconnectWallet" onclick="disconnectWallet()" style="display: none"><i class="fa fa-sign-out"></i> Disconnect wallet</button>
    </p>
    
    <div id="nfts_list">
        <p>
            <i class="fa fa-info-circle"></i>
            Please connect your wallet to get the NFTs you own.
        </p>
    </div>
    
    <fieldset id="step1" style="display: none">
        <legend><i class="fa fa-leaf"></i> NFT info</legend>
        <div id="nft_info">
            <span class="caption">NFT address:</span>
            <input type="text" readonly id="nft_address" value="">
            <a id="link_to_nft" href="" target="_blank"><i class="fa fa-external-link fa-fw"></i></a>
            <span class="caption">NFT metadata URI:</span>
            <input type="text" readonly id="metadata_uri" value="">
            <a id="link_to_nft_metadata" href="" target="_blank"><i class="fa fa-external-link fa-fw"></i></a>
            <span class="caption">NFT piggy bank address:</span>
            <input type="text" readonly id="vault_pda" value="">
            <a id="link_to_vault_pda" href="" target="_blank"><i class="fa fa-external-link fa-fw"></i></a>
        </div>
    </fieldset>
    
    <fieldset id="step2" style="display: none; overflow: auto;">
        <legend><i class="fa fa-piggy-bank"></i> Piggy Bank holdings</legend>
        <div id="tokensList"></div>
        <p>
            Amount:
            <input id="amount" type="number" step="any" value="0" style="text-align: center; width: 100px;">
        </p>
        <p id="withdrawalResult" style="margin-bottom: 0"></p>
    </fieldset>
    
    <p id="credits" class="aligncenter">
        Part of the <a href="https://volkachain.tech/tokenizer" target="_blank">Volkachain Tokenizer Framework</a> by
        <a href="https://www.lavasoftworks.com" target="_blank"><i class="fa-solid fa-volcano fa-fw"></i>LAVA SoftWorks</a>
        •
        Open sourced at <a href="https://github.com/LAVASoftWorks/vkct_withdrawal_facility" target="_blank"><i class="fa-brands fa-github fa-fw"></i>GitHub</a>
        <br>
        Powered by
        <a href="https://solana.com/docs/clients/javascript" target="_blank"><i class="fa fa-cubes fa-fw"></i>Solana Web3</a>
        •
        <a href="https://irys.xyz/" target="_blank"><i class="fa fa-server fa-fw"></i>Irys</a>
        •
        <a href="https://jquery.com/" target="_blank"><i class="fa-brands fa-js fa-fw"></i>jQuery</a>
        •
        <a href="https://fontawesome.com/" target="_blank"><i class="fa-brands fa-font-awesome fa-fw"></i>FontAwesome</a><br>
        <a href="#" onclick="showWarn()"><i class="fa fa-info-circle fa-fw"></i>About this page</a>
    </p>
</div>

<!-- =============== -->
<!-- Helper sections -->
<!-- =============== -->

<template id="withdrawalResult_src">
    <button id="witdhraw_button" onclick="withdraw()"><i class="fa fa-upload"></i> Withdraw</button>
</template>

<div id="progress_overlay">
    <div id="progress_message"></div>
</div>

<div id="initial_warning">
    <div class="content">
        <h2 style="display: grid; grid-template-columns: 1fr auto; width: 100%; margin: 0 0 5px 0; gap: 10px;">
            <span class="ellipsified">
                Piggy Bank Withdrawal Facility v<span class="script_version">N/A</span>
            </span>
            <span class="close_trigger">
                <i id="warn_closer" class="pseudo_link fa fa-times-circle fa-lg" onclick="hideWarn()"></i>
            </span>
        </h2>
        <div class="inner_content">
            <p>
                This page is a fully descentralized webapp that interacts with the
                Phantom wallet to allow fungible token withdrawals owned by NFTs
                made with the Volkachain Tokenizer Framework.
            </p>
            <p>
                It won't run any transaction other than calling the smart contract
                that transfers the tokens from the NFT you own to your wallet.
            </p>
            <p>
                <i class="fa fa-warning"></i> <b>Important:</b>
                This file should be hosted at <b>irys.xyz</b>.
                If the URL on your browser address bar doesn't match, then <b>you're at the wrong location.</b>
            </p>
            <p>
                <b style="color: red">Never open this file directly.</b>
                Always go to the NFT and click on the "Website" or "External link" attribute.
                That link points to the latest version of this file as stored on the Solana blockchain.
                <a href="https://solscan.io/address/LvWCuijVK4pTp24VTV63UriXHZbLPFcZAwjUERoZrJR" 
                   target="_top">Go to the NFT profile now <i class="fa fa-external-link"></i></a><br>
                <b>Bookmark the NFT page, not this one!</b>
            </p>
            <p>
                <strong><i class="fa fa-info-circle"></i> Disclaimer:</strong>
                This interface is provided as-is, without warranties or obligations of any kind.
                Always double-check transaction details in your wallet.
            </p>
            <p>
                If you want to compare this page against the published one in the GitHub repo,
                You can do it by following the next instructions:
            </p>
            <ol>
                <li>
                    Hit Ctrl-U (Windows) or Command-Option-U (Mac) to view the source code of this page.
                    It will open on a new tab.
                </li>
                <li>
                    Open the raw content of the latest published version of this page at GitHub on a new tab:
                    <a href="https://github.com/LAVASoftWorks/vkct_withdrawal_facility/blob/master/index.html"
                       target="_blank">github.com/.../blob/master/index.html</a>
                </li>
                <li>
                    Open Diffchecker on another tab:
                    <a href="https://www.diffchecker.com/" target="_blank">diffchecker.com</a>
                </li>
                <li>
                    Copy the raw content of the page at GitHub and paste it on the <u>Original text</u> area of DiffChecker.
                </li>
                <li>
                    Copy the source code of this page and paste it at the <u>Changed text</u> area of DiffChecker.
                </li>
                <li>
                    Make sure that both areas have the same amount of code lines!
                    Sometimes, the browser adds blank lines at the top and/or the bottom of the source code.<br>
                    If you spot them, remove them.
                </li>
                <li>
                    Hit the "Find difference" button. You should see no differences.
                    If there are any, then <b>don't trust this page</b>.
                </li>
            </ol>
            <p class="aligncenter">
                <button onclick="hideWarn()">
                    <i class="fa fa-times"></i> Dismiss
                </button>
            </p>
        </div>
    </div>
</div>

<!-- ============ -->
<!-- Script logic -->
<!-- ============ -->

<script>
    //-----------//
    // Bootstrap //
    //-----------//
    
    function showWarn()
    {
        $('body').css('overflow', 'hidden');
        $('#initial_warning').show();
    }
    
    function hideWarn()
    {
        if( sessionStorage ) sessionStorage.setItem('vkwf_warn_seen', 'true');
        $('body').css('overflow', 'auto');
        $('#initial_warning').hide();
    }
    
    function setApiUrl()
    {
        let val = $('#API_URL').val();
        if( $.trim(val) === '' ) localStorage.removeItem('vkwf_api_url');
        else                     localStorage.setItem('vkwf_api_url', val);
        location.reload();
    }
    
    $(document).ready(function()
    {
        if( window.location.href !== window.top.location.href )
        {
            $('#piggybank_withdrawal_widget').html(`
                <div id="initial_warning">
                    <b><i class="fa fa-warning"></i> Location mismatch</b><br><br>
                    This script is being opened through an iframe.<br><br>
                    All functions have been disabled.
                </div>
            `);
            return;
        }
        
        $('.script_version').text(script_version);
        
        if( ! localStorage )
        {
            showWarn();
            return;
        }
        
        if( ! sessionStorage )
        {
            showWarn();
            return;
        }
        
        let url = localStorage.getItem('vkwf_api_url');
        if( url ) API_URL = url;
        $('#API_URL').val(API_URL);
        connection = new solanaWeb3.Connection(API_URL);
        
        if( sessionStorage.getItem('vkwf_warn_seen') ) return;
        
        showWarn();
    });
</script>

<script>
    //--------------------//
    // User interface ops //
    //--------------------//
    
    let vaultPDA = null;
    let nftCollectionAddr = null;
    
    function toggleUI(onoff)
    {
        $('#piggybank_withdrawal_widget').toggleClass('blocked', onoff === 'off');
    }
    
    function showProgress(message = '')
    {
        let $overlay = $('#progress_overlay');
        let $target  = $('#progress_message');
        let $body    = $('body');
        
        if( message === '' )
        {
            $body.css('overflow', 'initial');
            $overlay.toggleClass('visible', false);
            return;
        }
        
        $target.html(`<i class="fa fa-spinner fa-pulse"></i> ${message}`);
        $overlay.toggleClass('visible', true);
        $overlay.show();
    }
    
    function hideProgress()
    {
        showProgress();
    }
    
    async function getNFTmetadata()
    {
        toggleUI('off');
        showProgress("Fetching NFT metadata...");
        let uri  = $('#metadata_uri').val().trim();
        if( uri === '' )
        {
            alert('Please paste the NFT metadata URI');
            toggleUI('on');
            hideProgress();
            return;
        }
        
        $.getJSON(uri, function(data) {
            
            if( data.attributes === undefined )
            {
                alert('Invalid data received.');
                toggleUI('on');
                hideProgress();
                return;
            }
            
            for(let i in data.attributes)
            {
                let attr = data.attributes[i];
                if( attr.trait_type === PIGGYBANK_TRAIT_KEY )
                {
                    vaultPDA = attr.value;
                }
                else if( attr.trait_type === COLLECTION_TRAIT_KEY )
                {
                    nftCollectionAddr = attr.value;
                }
            }
            
            if( vaultPDA === null )
            {
                alert("Could'nt find the piggy bank address in the NFT metadata.");
                disableSelectedToken();
                $('#step1, #step2').hide();
                toggleUI('on');
                hideProgress();
                return;
            }
            
            if( nftCollectionAddr === null )
            {
                alert("Could'nt find the collection address reference in the NFT metadata.");
                disableSelectedToken();
                $('#step1, #step2').hide();
                toggleUI('on');
                hideProgress();
                return;
            }
            
            $('#vault_pda').val(vaultPDA);
            const pda_link = explorerLink.replace('<endpoint>', 'address').replace('<data>', vaultPDA);
            $('#link_to_vault_pda').attr('href', pda_link);
            
            populateTokenDropdown();
        })
        .fail(function(error) {
            alert(`Error: ${error.status}: ${error.statusText}`);
            toggleUI('on');
            hideProgress();
        });
    }
    
    async function populateTokenDropdown()
    {
        toggleUI('off');
        showProgress("Fetching NFT piggy bank balances...");
        const $container = $("#tokensList");
        $container.html('');
        
        showProgress("Fetching NFT piggy bank accounts...");
        const pb_pda   = new solanaWeb3.PublicKey(vaultPDA);
        const accounts = await connection.getParsedTokenAccountsByOwner(pb_pda, {
            programId: new solanaWeb3.PublicKey(TOKEN_PROGRAM_ID)
        });
        if( accounts.value.length === 0 )
        {
            disableSelectedToken();
            alert("This NFT doesn't have piggy bank accounts.");
            $('#step1, #step2').hide();
            toggleUI('on');
            hideProgress();
            return;
        }
        const atas_by_mint = {};
        for(let item of accounts.value)
        {
            const account = item.account;
            if( ! (account.data && account.data.parsed && account.data.parsed.info) ) continue;
            const item_pubkey = item.pubkey.toBase58();
            const item_info   = account.data.parsed.info;
            const item_mint   = item_info.mint;
            atas_by_mint[item_mint] = item_pubkey;
        }
        if( Object.keys(atas_by_mint).length === 0 )
        {
            disableSelectedToken();
            alert("No compatible piggy bank accounts found for this NFT.");
            $('#step1, #step2').hide();
            toggleUI('on');
            hideProgress();
            return;
        }
        
        for(let mintaddr in atas_by_mint)
        {
            let addr = atas_by_mint[mintaddr];
            for(let symbol in SUPPORTED_TOKENS)
            {
                let supported_token = SUPPORTED_TOKENS[symbol];
                if( supported_token.address === mintaddr )
                {
                    const name       = SUPPORTED_TOKENS[symbol].name;
                    const ata        = new solanaWeb3.PublicKey(addr);
                    const decimals   = SUPPORTED_TOKENS[symbol].decimals;
                    const short_mint = ellipsify_string(mintaddr, 8);
                    const short_addr = ellipsify_string(addr, 4);
                    showProgress(`Fetching ${name} <code>${short_addr}</code> info...`);
                    const accountInfo = await connection.getAccountInfo(ata);
                    
                    if ( ! accountInfo ) {
                        console.log(`Account info for ${symbol} ATA (${addr}) not found!`);
                        continue;
                    }
                    
                    const { amount }    = parseSplTokenAccountData(accountInfo.data);
                    const displayAmount = Number(amount) / Math.pow(10, decimals);
                    const balance       = displayAmount.toString();
                    const explorerUrl1  = explorerLink.replace('<endpoint>', 'address').replace('<data>', mintaddr);
                    const explorerUrl2  = explorerLink.replace('<endpoint>', 'address').replace('<data>', addr);
                    
                    $container.append(`
                        <label class="tokenElement" data-symbol="${symbol}" 
                               data-mint="${mintaddr}"
                               data-decimals="${decimals}">
                            <input type="radio" name="selectedToken" value="${ata}">
                            <span class="item_symbol">${symbol}</span>
                            <span class="item_name">${name}</span>
                            <span class="fixed_font"><a href="${explorerUrl1}" target="_blank"><i class="fa fa-info-circle fa-fw"></i>${short_mint}</a></span>
                            <span class="fixed_font"><a href="${explorerUrl2}" target="_blank"><i class="fa fa-wallet fa-fw"></i>${short_addr}</a></span>
                            <span class="balance fixed_font" style="justify-self: right">${balance}</span>
                        </label>
                    `);
                }
            }
        }
        
        if( $container.find('.tokenElement').length === 0 )
        {
            $container.append(`<p class="error">No valid piggy bank accounts found for this NFT.</p>`);
            toggleUI('on');
            hideProgress();
            return
        }
        
        $container.prepend(`
            <div class="tokenElement heading">
                <span><i class="fa fa-hand-point-down fa-fw"></i></span>
                <span>Token</span>
                <span>Name</span>
                <span>Mint address</span>
                <span>Wallet</span>
                <span class="balance" style="justify-self: right">Balance</span>
            </div>
        `);
        $container.find('input:first').prop('checked', true);
        
        $('#step1').show();
        $('#step2').show();
        $('#nft_address').prop('readonly', true);
        toggleUI('on');
        hideProgress();
    }
    
    function parseSplTokenAccountData(data)
    {
        const mint = new solanaWeb3.PublicKey(data.slice(0, 32));
        const owner = new solanaWeb3.PublicKey(data.slice(32, 64));
        // Amount: bytes 64-71, little-endian
        // Use DataView to read 8 bytes as little-endian unsigned integer (BigUint64)
        const amountBuffer = data.slice(64, 72);
        // Create a DataView; make sure it's an ArrayBuffer
        const amount = new DataView(amountBuffer.buffer, amountBuffer.byteOffset, 8)
        .getBigUint64(0, true); // true = little-endian
        return { mint, owner, amount };
    }
    
    function setSelectedToken(item)
    {
        let $items = $('#nfts_list .nft');
        let $this = $(item);
        let mint  = $this.attr('data-mint');
        let uri   = $this.attr('data-uri');
        
        $items.toggleClass('selected', false);
        $this.toggleClass('selected', true);
        
        $('#nft_address').val(mint);
        $('#link_to_nft').attr('href', explorerLink.replace('<endpoint>', 'address').replace('<data>', mint))
        $('#metadata_uri').val(uri);
        $('#link_to_nft_metadata').attr('href', uri);
        
        $('#withdrawalResult').html( $('#withdrawalResult_src').html() ).toggleClass('done', false);
        getNFTmetadata();
    }
    
    function disableSelectedToken()
    {
        $(`#nfts_list .nft.selected`).toggleClass('selected', false).toggleClass('enabled', false).toggleClass('disabled', true);
    }
    
    function resetUI()
    {
        $('#withdrawalResult').html( $('#withdrawalResult_src').html() ).toggleClass('done', false);
        let $controls = $("#piggybank_withdrawal_widget").find('input:not(#dest), button');
        $controls.prop('disabled', false);
        
        let mint = $('#nft_address').val();
        let item = $(`#nfts_list .nft[data-mint="${mint}"]`)[0];
        setSelectedToken(item);
        toggleUI('on');
        hideProgress();
    }
    
    function ellipsify_string(string, side_length)
    {
        return string.substring(0, side_length) + '…' + string.substring(string.length - side_length);
    }
</script>

<script>
    //------------//
    // Wallet ops //
    //------------//
    
    function getSolanaProvider()
    {
        if ("solana" in window) {
            const provider = window.solana;
            if (provider.isPhantom || provider.isBackpack || provider.isSolflare || provider.isLedger || provider.isWallet) {
                return provider;
            }
        }
        return null;
    }
    
    async function connectWallet()
    {
        wallet_provider = getSolanaProvider();
        
        if (window.solana && wallet_provider) {
            const response = await window.solana.connect();
            wallet = response.publicKey;
            const addr = wallet.toBase58();
            wallet_address = addr;
            console.log("Connected to wallet:", addr);
            document.getElementById("dest").value = addr;
            $("#connectWallet").hide();
            $("#disconnectWallet").show();
            await populateOwnedTokens();
        } else {
            alert("Wallet not found");
        }
    }
    
    async function populateOwnedTokens()
    {
        toggleUI('off');
        showProgress("Fetching owned NFTs...");
        
        let accounts;
        try
        {
            accounts = await connection.getParsedTokenAccountsByOwner(wallet, {
                programId: new solanaWeb3.PublicKey(TOKEN_PROGRAM_ID)
            });
        }
        catch(e)
        {
            alert(`Unable to connect to the Solana API:\n\n${e}\n\nPlease use a different API URL and try again.`);
            toggleUI('on');
            hideProgress();
            return;
        }
        
        if( ! accounts.value || accounts.value.length <= 0 )
        {
            alert("No tokens held by this wallet.");
            toggleUI('on');
            hideProgress();
            return;
        }
        
        let tokens = [];
        for( const { account } of accounts.value )
        {
            const info = account.data.parsed.info;
            let token = {};
            if( info.tokenAmount.decimals !== 0 ) continue;
            if( info.tokenAmount.uiAmount !== 1 ) continue;
            
            token = {
                mint: info.mint,
                uri:  null,
            };
            
            console.log('Got NFT:', token.mint);
            let short_addr = ellipsify_string(token.mint, 4);
            showProgress(`Fetching <code>${short_addr}</code> metadata...`);
            const [metadataPDA] = solanaWeb3.PublicKey.findProgramAddressSync(
                [
                    new TextEncoder().encode('metadata'),
                    METADATA_PROGRAM_ID.toBuffer(),
                    new solanaWeb3.PublicKey(token.mint).toBuffer(),
                ],
                METADATA_PROGRAM_ID
            );
            console.log('%c>>> MetadataPDA:', 'color: #B4ECFF', metadataPDA.toBase58());
            
            showProgress(`Fetching ${short_addr} account info...`);
            const accountInfo = await connection.getAccountInfo(metadataPDA);
            const uri = extractUriFromMetadataAccount(accountInfo.data);
            console.log(`%c>>> Metadata URI: ${uri}`, 'color: #B4ECFF');
            
            token.uri = uri;
            tokens.push(token);
        }
        
        showProgress(`${tokens.length} NFTs found.`);
        let $container = $('#nfts_list');
        if( tokens.length === 0 )
        {
            $container.html(`
                <p style="color: maroon">
                    <i class="fa fa-warning"></i> You don't have any NFTs in your wallet.
                </p>
            `);
            toggleUI('on');
            hideProgress();
            return;
        }
        
        $container.html('<div style="width: 100%">Select a token to check:</div>');
        for(const token of tokens)
        {
            let short_mint = ellipsify_string(token.mint, 4);
            $container.append(`
                <span class="nft" data-mint="${token.mint}" data-uri="${token.uri}"
                      onclick="setSelectedToken(this)">
                    <span class="image"></span><br>
                    <span class="mint fixed_font">${short_mint}</span><br>
                    <span class="symbol fixed_font">Please wait...</span><br>
                    <span class="name">Please wait...</span><br>
                </span>
            `);
        }
        
        $container.find('.nft').each(function() {
            const $this = $(this);
            const url   = $this.attr('data-uri');
            $.getJSON(url, function(data) {
                $this.find('.symbol').text(data.symbol);
                $this.find('.name').text(data.name);
                $this.find('.image').html(`<img src="${data.image}">`);
                $this.toggleClass('enabled', true);
            })
        });
        toggleUI('on');
        hideProgress();
    }
    
    async function disconnectWallet()
    {
        if (window.solana && wallet_provider) {
            try {
                await window.solana.disconnect();
                // Optional: Reset UI, clear fields, show connect button again, etc.
                location.reload();
            } catch (e) {
                alert("Failed to disconnect wallet: " + e.message);
            }
        }
    }
    
    async function withdraw()
    {
        toggleUI('off');
        let $controls = $("#piggybank_withdrawal_widget").find('input:not(#dest), button');
        
        if( ! wallet )
        {
            alert("Please connect the wallet.");
            toggleUI('on');
            return;
        }
        
        // Get selected token mint and corresponding NFT mint
        const $selectedItem      = $('input[name="selectedToken"]:checked');
        const symbol             = $selectedItem.closest('label').attr('data-symbol');
        const selectedTokenMint  = $selectedItem.closest('label').attr('data-mint');
        const selectedTokenPDA   = vaultPDA;
        const selectedTokenATA   = $selectedItem.val();
        
        // NFT mint input
        const NFT_MINT_ADDRESS = document.getElementById("nft_address").value.trim();
        if (NFT_MINT_ADDRESS === "") {
            alert("Please paste the NFT mint address");
            toggleUI('on');
            return;
        }
        
        // Other inits
        const walletPubkey = wallet;
        const nftMint      = new solanaWeb3.PublicKey(NFT_MINT_ADDRESS);
        const SPLtokenMint = new solanaWeb3.PublicKey(selectedTokenMint);
        
        showProgress("Checking NFT ownership...");
        if( ! await isHolderOf(nftMint) )
        {
            alert("You don't own this NFT.")
            toggleUI('on');
            hideProgress();
            return;
        }
        
        showProgress("Checking amount...");
        const amount = parseFloat(document.getElementById("amount").value);
        if (isNaN(amount) || amount <= 0) {
            alert(`Please enter the amount of ${symbol}`);
            toggleUI('on');
            return;
        }
        
        const decimals = parseInt($selectedItem.closest('label').attr('data-decimals'));
        const bigamount = BigInt(Math.round(amount * (10 ** decimals)));
        
        showProgress("Building account requirements...");
        // 1. User's NFT token account (ATA for nftMint)
        const userNftTokenAccount = await getAssociatedTokenAddress(nftMint, walletPubkey);
        // OR: Use the function above to make sure you get the actual token account with 1 token
        // const userNftTokenAccount = await findNftTokenAccount(walletPubkey, nftMint);
        
        // 2. User's SPL token ATA (recipient of withdrawal)
        const userSplTokenAccount = await getAssociatedTokenAddress(SPLtokenMint, walletPubkey);
        
        // 3a. Vault PDA account (using contract's seeds)
        // const vaultAccount = getVaultPda(nftMint, SPLtokenMint);
        const vaultAccount = new solanaWeb3.PublicKey(selectedTokenPDA);
        
        // 3b. Vault ATA account
        const vaultSplTokenAccount = new solanaWeb3.PublicKey(selectedTokenATA);
        
        const solanaWeb3_SystemProgram = solanaWeb3.SystemProgram.programId;
        
        const tokenRegistryPDA = new solanaWeb3.PublicKey(TOKEN_REGISTRY_PDA);
        
        const collectionMint     = new solanaWeb3.PublicKey(nftCollectionAddr);
        const collectionRegPDA   = new solanaWeb3.PublicKey(COLLECTION_REG_PDA);
        
        const [metadataPDA] = solanaWeb3.PublicKey.findProgramAddressSync(
            [
                new TextEncoder().encode('metadata'),
                METADATA_PROGRAM_ID.toBuffer(),
                nftMint.toBuffer(),
            ],
            METADATA_PROGRAM_ID
        );
        
        // 4. The rest: Programs and sysvars
        let keys = [
            { pubkey: walletPubkey,                  isSigner: true,  isWritable: true  }, // [ 0] signer
            { pubkey: nftMint,                       isSigner: false, isWritable: false }, // [ 1] nft_mint
            { pubkey: SPLtokenMint,                  isSigner: false, isWritable: false }, // [ 2] token_mint
            { pubkey: userNftTokenAccount,           isSigner: false, isWritable: true  }, // [ 3] nft_token_account (where user holds the NFT)
            { pubkey: tokenRegistryPDA,              isSigner: false, isWritable: false }, // [ 4] per-se
            { pubkey: vaultAccount,                  isSigner: false, isWritable: false }, // [ 5] vault (the PDA, SystemAccount)
            { pubkey: collectionMint,                isSigner: false, isWritable: false }, // [ 6] collection_mint
            { pubkey: collectionRegPDA,              isSigner: false, isWritable: false }, // [ 7] collection_registry PDA
            { pubkey: vaultSplTokenAccount,          isSigner: false, isWritable: true  }, // [ 8] vault_token_ata (ATA of SPL token, authority = vault PDA)
            { pubkey: userSplTokenAccount,           isSigner: false, isWritable: true  }, // [ 9] user_token_ata (ATA of SPL token, authority = signer)
            { pubkey: metadataPDA,                   isSigner: false, isWritable: false }, // [10] NFT Metadata PDA
            { pubkey: TOKEN_PROGRAM_ID,              isSigner: false, isWritable: false }, // [11] token_program
            { pubkey: ASSOCIATED_TOKEN_PROGRAM_ID,   isSigner: false, isWritable: false }, // [12] associated_token_program
            { pubkey: solanaWeb3_SystemProgram,      isSigner: false, isWritable: false }, // [13] system_program
        ];
        
        console.log(`
            Key  0 (Wallet Pubkey):              ${keys[ 0].pubkey.toString()}
            Key  1 (NFT mint):                   ${keys[ 1].pubkey.toString()}
            Key  2 (SPL token mint):             ${keys[ 2].pubkey.toString()}
            Key  3 (User NFT token account):     ${keys[ 3].pubkey.toString()}
            Key  4 (Token registry PDA):         ${keys[ 4].pubkey.toString()}
            Key  5 (Vault account):              ${keys[ 5].pubkey.toString()}
            Key  6 (Collection mint address):    ${keys[ 6].pubkey.toString()}
            Key  7 (Collection registry PDA):    ${keys[ 7].pubkey.toString()}
            Key  8 (Vault SPL token account):    ${keys[ 8].pubkey.toString()}
            Key  9 (User SPL token account):     ${keys[ 9].pubkey.toString()}
            Key 10 (NFT metadata PDA):           ${keys[10].pubkey.toString()}
            Key 11 (Solana token program):       ${keys[11].pubkey.toString()}
            Key 12 (Solana assoc token program): ${keys[12].pubkey.toString()}
            Key 13 (Solana SYSTEM PROGRAM):      ${keys[13].pubkey.toString()}
        `.replace(/ {12}K/g, 'K'));
        
        $controls.prop('disabled', true);
        
        // Instruction data
        const data = buildWithdrawData(bigamount);
        
        const ix = new solanaWeb3.TransactionInstruction({
            keys: keys,
            programId: new solanaWeb3.PublicKey(PIGGYBANK_PROGRAM_ID),
            data: data
        });
        
        const tx = new solanaWeb3.Transaction().add(ix);
        tx.feePayer = wallet;
        tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;
        
        // Step: simluation
        showProgress("Running smart contract call simulation...");
        console.log("%cRunning simulation", "color: teal");
        const simulation = await connection.simulateTransaction(tx);
        let has_errors = false;
        console.log("%cSimulation results:", "color: teal");
        for (let line of simulation.value.logs)
        {
            if( line.match(/error/i) )
            {
                console.error(line);
                has_errors = true;
            }
            else
            {
                console.log("%c%s", "color: teal", line);
            }
        }
        
        if( has_errors ) {
            alert("The simulation has errors. Please check the JS console for debug info.");
            $controls.prop('disabled', false);
            toggleUI('on');
            hideProgress();
            return;
        }
        
        // Segment: send!
        showProgress("Executing smart contract call...");
        console.log("%cExecuting transaction", "color: skyblue");
        let signedTx;
        try
        {
            signedTx = await window.solana.signTransaction(tx);
        }
        catch( e )
        {
            alert( e.toString() );
            $controls.prop('disabled', false);
            toggleUI('on');
            hideProgress();
            return;
        }
        
        let sig;
        try {
            console.log("%cTransmitting transaction...", "color: goldenrod");
            sig = await connection.sendRawTransaction(signedTx.serialize());
        } catch (e) {
            if (e.logs) {
                console.error("Transaction failed with logs:");
                for (let line of e.logs) console.error(line);
            }
            console.error("SendTransactionError:", e);
            $controls.prop('disabled', false);
            toggleUI('on');
            hideProgress();
            return;
        }
        
        showProgress("Confirming the transaction...");
        console.log("%cConfirming...", "color: magenta");
        await connection.confirmTransaction(sig);
        console.log(`%cTransaction sent: ${sig}`, "color: green");
        
        toggleUI('on');
        hideProgress();
        let url = explorerLink.replace("<endpoint>", "tx").replace("<data>", sig);
        let shortened_sig = ellipsify_string(sig, 8);
        let $target = $(('#withdrawalResult'));
        $target
            .toggleClass('done', true)
            .html(`
                <i class="fa fa-check-circle fa-lg"></i>
                <b style="color: green">Transaction sent!</b> Signature:
                <a href="${url}" target="_blank">${shortened_sig}</a>
                <br><br>
                <button onclick="resetUI()"><i class="fa fa-refresh"></i> Reset</button>
            `);
    }
    
    function buildWithdrawData(amount)
    {
        // Use the discriminator from your IDL
        const discriminator = Uint8Array.from(IDL_DISCRIMINATOR);
        // Amount as u64 little-endian
        const amountBuffer = new ArrayBuffer(8);
        const view = new DataView(amountBuffer);
        view.setBigUint64(0, BigInt(amount), true); // true = little-endian
        
        // Concatenate discriminator and amount
        const data = new Uint8Array(16);
        data.set(discriminator, 0);
        data.set(new Uint8Array(amountBuffer), 8);
        // console.log( data );
        return data;
    }
    
    async function getAssociatedTokenAddress(mint, owner)
    {
        // See: @solana/spl-token getAssociatedTokenAddress() in web3.js
        return (
            solanaWeb3.PublicKey.findProgramAddressSync(
                [
                    owner.toBuffer(),
                    TOKEN_PROGRAM_ID.toBuffer(),
                    mint.toBuffer()
                ],
                ASSOCIATED_TOKEN_PROGRAM_ID
            )
        )[0];
    }
    
    async function isHolderOf(nftMint)
    {
        const accounts = await connection.getTokenAccountsByOwner(wallet, {
            mint: nftMint
        });
        
        // If user owns multiple, pick the one with amount == 1
        for (let acc of accounts.value) {
            const amount = Number(
                new DataView(acc.account.data.buffer, 64, 8).getBigUint64(0, true)
            );
            if (amount === 1) {
                return true; // new PublicKey(acc.pubkey);
            }
        }
        return false;
        // throw new Error("NFT token account not found or user does not own this NFT.");
    }
</script>

<script>
    // ----------------------------------------------------- //
    // Replacement for missing spl-token-metadata dependency //
    // ----------------------------------------------------- //
    
    function readUInt32LE(bytes, offset)
    {
        return (
            bytes[offset] +
            (bytes[offset + 1] << 8) +
            (bytes[offset + 2] << 16) +
            (bytes[offset + 3] << 24)
        );
    }
    
    function extractUriFromMetadataAccount(data)
    {
        let offset = 1 + 32 + 32; // key + updateAuth + mint
        // name
        let nameLen = readUInt32LE(data, offset);
        offset += 4 + nameLen;
        // symbol
        let symbolLen = readUInt32LE(data, offset);
        offset += 4 + symbolLen;
        // uri
        let uriLen = readUInt32LE(data, offset);
        offset += 4;
        const uriBytes = data.slice(offset, offset + uriLen);
        const uri = new TextDecoder().decode(uriBytes).replace(/\0/g, '');
        return uri;
    }
</script>

</body>
</html>
